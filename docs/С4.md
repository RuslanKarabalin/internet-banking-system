# С4

## Context

Рассмотрим систему в контексте внешнего мира -
кто использует систему и
с какими внешними системами она взаимодействует:

```mermaid
graph TB
    User[Пользователь<br/>Клиент банка]
    Admin[Администратор<br/>Сотрудник банка]
    
    BankSystem[Bank System]
    
    EmailSystem[Email System<br/>Отправка уведомлений]
    MonitoringSystem[Monitoring System<br/>Система мониторинга операций]
    
    User -->|Регистрация, переводы,<br/>просмотр баланса| BankSystem
    Admin -->|Управление пользователями,<br/>мониторинг| BankSystem
    BankSystem -->|Отправка email<br/>уведомлений| EmailSystem
    BankSystem -->|Логи операций| MonitoringSystem
    
    style BankSystem fill:#1168bd,color:#ffffff
    style User fill:#08427b,color:#ffffff
    style Admin fill:#08427b,color:#ffffff
    style EmailSystem fill:#999999,color:#ffffff
    style MonitoringSystem fill:#999999,color:#ffffff
```

### Описание контекста

**Пользователи:**

- **Пользователь** - клиент банка, который может:
  - Регистрироваться в системе
  - Создавать счета
  - Выпускать карты
  - Совершать переводы
  - Просматривать историю операций
  
- **Администратор** - сотрудник банка, который может:
  - Управлять пользователями
  - Просматривать все операции
  - Блокировать счета/карты
  - Мониторить систему

**Внешние системы:**

- Email System - внешний сервис для отправки уведомлений
- Audit System - централизованная система логирования для compliance

> _Внешние системы указаны для примера,
скорее всего я не буду добавлять взаимодействия с внешнимим апи_

## Containers

Рассмотри основные компоненты системы
(микросервисы, базы данных, очереди сообщений).

```mermaid
graph TB
    User[Пользователь]
    Admin[Администратор]
    
    subgraph "Go Bank System"
        APIGateway[API Gateway<br/>Go + Gin<br/>Порт: 8080<br/>Маршрутизация, аутентификация]
        
        subgraph "Core Services"
            UserService[User Service<br/>Go<br/>Порт: 8081<br/>Управление пользователями,<br/>аутентификация JWT]
            AccountService[Account Service<br/>Go<br/>Порт: 8082<br/>Управление счетами,<br/>проверка баланса]
            CardService[Card Service<br/>Go<br/>Порт: 8083<br/>Управление картами,<br/>привязка к счетам]
            TransferService[Transfer Service<br/>Go<br/>Порт: 8084<br/>Переводы между счетами,<br/>Saga Pattern]
        end
        
        subgraph "Data Storage"
            UserDB[(User DB<br/>PostgreSQL<br/>Данные пользователей)]
            AccountDB[(Account DB<br/>PostgreSQL<br/>Счета и балансы)]
            CardDB[(Card DB<br/>PostgreSQL<br/>Карты)]
            TransferDB[(Transfer DB<br/>PostgreSQL<br/>История транзакций)]
        end
        
        MessageBroker[Message Broker<br/>Kafka/RabbitMQ<br/>Асинхронные события]
        
        Cache[Redis Cache<br/>Кэширование токенов,<br/>сессий, балансов]
    end
    
    EmailSystem[Email Service]
    
    User -->|HTTPS/REST| APIGateway
    Admin -->|HTTPS/REST| APIGateway
    
    APIGateway -->|HTTP/gRPC| UserService
    APIGateway -->|HTTP/gRPC| AccountService
    APIGateway -->|HTTP/gRPC| CardService
    APIGateway -->|HTTP/gRPC| TransferService
    
    UserService -->|SQL| UserDB
    AccountService -->|SQL| AccountDB
    CardService -->|SQL| CardDB
    TransferService -->|SQL| TransferDB
    
    TransferService -.->|Publish events| MessageBroker
    AccountService -.->|Subscribe events| MessageBroker
    UserService -.->|Subscribe events| MessageBroker
    
    MessageBroker -.->|Notifications| EmailSystem
    
    APIGateway -->|Cache tokens| Cache
    AccountService -->|Cache balances| Cache
    
    style APIGateway fill:#1168bd,color:#ffffff
    style UserService fill:#438dd5,color:#ffffff
    style AccountService fill:#438dd5,color:#ffffff
    style CardService fill:#438dd5,color:#ffffff
    style TransferService fill:#438dd5,color:#ffffff
    style MessageBroker fill:#ff6b6b,color:#ffffff
    style Cache fill:#51cf66,color:#ffffff
```

### Описание контейнеров

#### 1. **API Gateway** (Порт: 8080)

- **Технология:** Go + Gin/Fiber
- **Функции:**
  - Единая точка входа для всех клиентов
  - Маршрутизация запросов к микросервисам
  - Аутентификация и авторизация (проверка JWT)
  - Rate limiting
  - Логирование запросов

#### 2. **User Service** (Порт: 8081)

- **Технология:** Go
- **База данных:** PostgreSQL (User DB)
- **Функции:**
  - Регистрация пользователей
  - Аутентификация (выдача JWT токенов)
  - Управление профилем
  - CRUD операции с пользователями
- **API:**
  - `POST /api/v1/users/register`
  - `POST /api/v1/users/login`
  - `GET /api/v1/users/{id}`
  - `PUT /api/v1/users/{id}`
  - `DELETE /api/v1/users/{id}`

#### 3. **Account Service** (Порт: 8082)

- **Технология:** Go
- **База данных:** PostgreSQL (Account DB)
- **Функции:**
  - Создание счетов
  - Проверка баланса
  - Обновление баланса (через события от Transfer Service)
  - Блокировка/разблокировка счетов
  - История операций по счету
- **API:**
  - `POST /api/v1/accounts` - создать счет
  - `GET /api/v1/accounts/{id}` - получить счет
  - `GET /api/v1/accounts/{id}/balance` - баланс
  - `GET /api/v1/accounts/user/{userId}` - счета пользователя
  - `PUT /api/v1/accounts/{id}/status` - блокировка

#### 4. **Card Service** (Порт: 8083)

- **Технология:** Go
- **База данных:** PostgreSQL (Card DB)
- **Функции:**
  - Выпуск карт
  - Привязка карты к счету
  - Блокировка/разблокировка карт
  - Генерация номера карты, CVV
  - CRUD операции с картами
- **API:**
  - `POST /api/v1/cards` - выпустить карту
  - `GET /api/v1/cards/{id}` - получить карту
  - `GET /api/v1/cards/account/{accountId}` - карты счета
  - `PUT /api/v1/cards/{id}/block` - заблокировать
  - `DELETE /api/v1/cards/{id}` - удалить

#### 5. **Transfer Service** (Порт: 8084)

- **Технология:** Go
- **База данных:** PostgreSQL (Transfer DB)
- **Функции:**
  - Переводы между счетами
  - Реализация Saga Pattern (для распределенных транзакций)
  - Валидация переводов
  - История всех транзакций
  - Отмена/возврат переводов
- **API:**
  - `POST /api/v1/transfers` - создать перевод
  - `GET /api/v1/transfers/{id}` - получить транзакцию
  - `GET /api/v1/transfers/account/{accountId}` - история счета
  - `POST /api/v1/transfers/{id}/rollback` - отменить

#### 6. **Message Broker** (Kafka/NATS/RabbitMQ)

- **Функции:**
  - Асинхронная коммуникация между сервисами
  - Event-driven архитектура
  - Гарантия доставки событий
- **События:**
  - `TransferCreated` - создан перевод
  - `TransferCompleted` - перевод завершен
  - `TransferFailed` - перевод не удался
  - `AccountBalanceUpdated` - баланс обновлен
  - `UserRegistered` - новый пользователь

#### 7. **Redis Cache**

- **Функции:**
  - Кэширование JWT токенов
  - Кэширование балансов счетов (short TTL)
  - Кэширование сессий
  - Rate limiting данные

#### 8. **PostgreSQL Databases**

- Каждый сервис имеет свою БД (Database per Service pattern)
- Изоляция данных
- Независимое масштабирование

## Components

## Code
